const npmlog=require("npmlog"),Eof=require("../util/eof"),errHndl=require("./error-handler");
(function(){const g=npmlog;g.heading="luna";g.level="http";const t={send:function(a,d,n,p,h){function q(b){c+=b;try{e=JSON.parse(c),c="",!1===e.returnValue?(k.destroy(),h(errHndl.getErrMsg("FAILED_CALL_LUNA",e.errorText?e.errorText:e.errorMessage?e.errorMessage:"",null,d.service))):p(e,function(f,r){f&&g.verbose("luna#send()",f.toString());if(f||r)g.verbose("luna#send()","closing exec stream"),h(f,r)})}catch(f){}}const m=a&&a.session,k=new Eof;let e;k.pause();const l=["luna:/",d.service,d.folder,
d.method].join("/");g.verbose("luna#send()","calling:",l);a=a&&a.nReplies?"-n "+a.nReplies+" ":"-i ";let c="";m.run(m.getDevice().lunaSend+" "+a+l+" '"+JSON.stringify(n)+"'",k,function(b){(Buffer.isBuffer(b)?b.toString():b).split(/\r?\n/).forEach(q)},process.stderr,function(b){b&&h(b)})},sendWithoutErrorHandle:function(a,d,n,p,h){function q(c){l+=c;try{e=JSON.parse(l),l="",p(e,function(b,f){if(b||f)g.verbose("luna#send()","closing exec stream"),h(b,f)})}catch(b){}}const m=a&&a.session,k=new Eof;let e;
k.pause();d=["luna:/",d.service,d.folder,d.method].join("/");g.verbose("luna#send()","calling:",d);a=a&&a.nReplies?"-n "+a.nReplies+" ":"-i ";let l="";m.run(m.getDevice().lunaSend+" "+a+d+" '"+JSON.stringify(n)+"'",k,function(c){(Buffer.isBuffer(c)?c.toString():c).split(/\r?\n/).forEach(q)},process.stderr,function(c){c&&h(c)})}};"undefined"!==typeof module&&module.exports&&(module.exports=t)})();
